/**
 * jQuery form builder
 * Copyright (c) 2014 (v3.0) Shlomi Nissan, 1ByteBeta (http://www.1bytebeta.com)
 * Licensed under the MIT (http://www.opensource.org/licenses/mit-license.php)
 */(function(e){e.fn.formBuilder=function(t){var n=e.extend({load_url:"/",save_url:"/"},t),r=function(){e(".new-element").click(function(){p();var t=e("#sortable-elements");t.sortable({stop:function(){d()}});var n=e(this).data("type"),r={label:"Untitled",position:e(".form-element").length-1};dust.render(n,r,function(n,s){t.append(s);i();var o=e("#element-"+r.position);m=o;m.addClass("selected");g.showTab("#field-settings");a();h();c()})})},i=function(){e(".form-element").unbind();e(".form-element").click(function(){p();e(this).addClass("selected");if(e(this).data("type")=="form-settings")g.showTab("#form-settings");else{g.showTab("#field-settings");m=e(this);a();h();c()}})},s=function(){e(".toolbox-tab").click(function(){p();e(this).data("target")=="#form-settings"&&e("#form-settings-element").addClass("selected");if(e(this).data("target")=="#field-settings"){if(!m){e("#element-0").addClass("selected");m=e("#element-0")}else m.addClass("selected");a();h()}})},o=function(){e(".bind-control").each(function(){var t=e(this).data("bind");e(this).on("keyup",function(){m==""?e(t).html(e(this).val()):m.data("type")!="element-dropdown"?m.find(t).next(".choice-label").html(e(this).val()):m.find(t).html(e(this).val())})})},u=function(){e(".option").unbind();e(".option").click(function(){var t=e(this).parent().next("input").data("bind"),n=e(m).data("type")!="element-dropdown"?"checked":"selected";e(m).find(t).prop(n,function(e,t){return!t})})},a=function(){e("#field-label").val(m.data("label"));e("#field-label").on("keyup",function(){m.children("label").children(".label-title").html(e(this).val());m.data("label",e(this).val())});m.data("type")=="element-section-break"&&e("#description").val(m.children(".description").html());e("#description").on("keyup",function(){m.children(".description").html(e(this).val());m.data("description",e(this).val())});if(m.data("type")=="element-multiple-choice"||m.data("type")=="element-checkboxes"||m.data("type")=="element-dropdown"){e("#field-choices").css("display","block");e("#field-choices").html('<div class="form-group"><label>Choices</label></div>');var t=[],n=m.children(".choices").children(".choice");m.data("type")=="element-dropdown"&&(n=m.children(".choices").children("option"));console.log(n);n.each(function(n){if(m.data("type")!="element-dropdown")var r=e(this).children("label").children("input").is(":checked")?!0:!1,i=e(this).children("label").children("input").attr("class"),s=e(this).children("label").children(".choice-label").html();else var s=e(this).val(),i=e(this).attr("class"),r=e(this).is(":selected")?!0:!1;var o={checked:r,title:s,position:n+1,bindingClass:i};t.push(o)});var r={choices:t};console.log(r);dust.render(m.children(".choices").data("type"),r,function(t,n){e("#field-choices").append(n);o();u();l()})}else e("#field-choices").css("display","none");m.hasClass("required")?e("#required").prop("checked",!0):e("#required").prop("checked",!1);e("#required").unbind();e("#required").change(function(){m.toggleClass("required");var e={};this.checked?dust.render("required",e,function(e,t){m.children("label").append(t)}):m.children("label").children(".required-star").remove()})},f=function(){e("#control-remove-field").click(function(){if(m!="")if(e(".form-element").length>2){m.remove();d();g.showTab("#add-field");p()}else alert("Unable to delete this field! You must have at least 1 field in your form.")});e("#control-add-field").click(function(){g.showTab("#add-field");p()})},l=function(){e(".remove-choice").unbind();e(".remove-choice").click(function(){if(e(this).parent().parent().children(".choice").length>1){var t=e(this).data("delete");e(m).data("type")=="element-dropdown"?e(m).find(t).remove():e(m).find(t).parent().parent().remove();e(this).parent().remove();o();l()}});e(".add-choice").unbind();e(".add-choice").click(function(){var t=2;if(m.data("type")=="element-dropdown")var n=m.children(".choices").children("option");else var n=m.children(".choices").children(".choice");console.log(n);e(n).each(function(n){if(m.data("type")=="element-dropdown")var r=e(this).attr("class");else var r=e(this).find("input").attr("class");var i=r.split("-");t<i[1]&&(t=i[1])});t++;var r={bindingClass:"option-"+t,title:"Untitled"},i={choices:r};dust.render(m.children(".choices").data("type"),i,function(n,r){e("#field-choices").append(r);m.data("type")=="element-multiple-choice"&&(template="choice-radio");m.data("type")=="element-checkboxes"&&(template="choice-checkbox");m.data("type")=="element-dropdown"&&(template="choice-dropdown");var s=m.attr("id").replace("element-","");i={title:"Untitled",value:"untitled",lastChoice:t,elementId:s};console.log(i);dust.render(template,i,function(e,t){m.children(".choices").append(t)});o();u();l()})})},c=function(){if(m.data("type")=="element-section-break"){e("#field-options").hide();e("#field-description").show()}else{e("#field-options").show();e("#field-description").hide()}},h=function(){topOffset=m.position().top;toolboxOffset=115;offset=topOffset-toolboxOffset;e("#field-settings").css("margin-top",offset+"px");e(".left-col").css("height","100%")},p=function(){e(".form-element").each(function(){e(this).removeClass("selected")})},d=function(){e("#sortable-elements").sortable({stop:function(){d()}});e("#sortable-elements li").each(function(t){e(this).attr("id","element-"+t)});i()},v=function(){var t={};t.title=e("#form-title").val();t.description=e("#form-description").val();t.fields=Array();e("#sortable-elements li").each(function(n){var r={title:e(this).data("label"),type:e(this).data("type"),required:e(this).hasClass("required")?!0:!1,position:n+1,description:e(this).data("description")};if(r["type"]=="element-multiple-choice"||r["type"]=="element-checkboxes"||r["type"]=="element-dropdown"){var i=[];r["type"]=="element-dropdown"?e(this).find(".choices").children("option").each(function(t){var n={title:e(this).val(),value:e(this).val(),checked:e(this).is(":selected")?!0:!1};i.push(n);r.choices=i}):e(this).find(".choices").children(".choice").each(function(t){var n={title:e(this).children("label").children(".choice-label").html(),value:e(this).children("label").children(".choice-label").html(),checked:e(this).children("label").children("input").is(":checked")?!0:!1};i.push(n);r.choices=i})}t.fields.push(r)});var n=JSON.stringify(t);return n},m="",g="";dust.onLoad=function(t,n){e.ajax("src/templates/"+t+".tpl",{success:function(e){n(undefined,e)},error:function(e,t,r){n(t,undefined)}})};var y={},b=this;dust.render("formbuilder-base",y,function(e,t){b.append(t)});e.getJSON(n.load_url,function(t){y={form:t,fieldSettings:!1,formSettings:!1};dust.render("formbuilder-fields",y,function(t,u){e(".loading").fadeOut(function(){e("#form-col").html(u);e("#form-elements").fadeIn();e("#form-title").val(y.form.title);e("#form-description").val(y.form.description);r();i();s();o();f();d();g=e(".nav-tabs").tabs();e("#save").click(function(t){var r=v();e.ajax({type:"POST",url:n.save_url,data:{formData:r},success:function(){n.onSaveForm.call()}})})})})})}})(jQuery);